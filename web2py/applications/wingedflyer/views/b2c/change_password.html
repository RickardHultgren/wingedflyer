<!-- views/b2c/change_password.html -->
{{extend 'layout.html'}}

<div class="container mt-4" style="max-width: 600px;">
    <div class="row mb-4">
        <div class="col-md-10">
            <h2>Change Password</h2>
            <p class="text-muted">Update your account password</p>
        </div>
        <div class="col-md-2 text-right">
            <a href="{{=URL('dashboard')}}" class="btn btn-secondary btn-sm">← Back</a>
        </div>
    </div>

    <div class="card">
        <div class="card-header bg-warning">
            <h5 class="mb-0"><i class="fas fa-key"></i> Password Change</h5>
        </div>
        <div class="card-body">
            {{if response.flash:}}
            <div class="alert alert-danger">
                {{=response.flash}}
            </div>
            {{pass}}

            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i>
                <strong>Password Requirements:</strong>
                <ul class="mb-0 mt-2">
                    <li>Use a strong, unique password</li>
                    <li>Don't share your password with anyone</li>
                    <li>Consider using a password manager</li>
                </ul>
            </div>

            {{=form}}
        </div>
    </div>
</div>

<!-- views/b2c/timeline.html -->
{{extend 'layout.html'}}

<div class="container mt-4">
    <div class="row mb-4">
        <div class="col-md-10">
            <h2>My Journey Timeline</h2>
            <p class="text-muted">Track your progress and communications</p>
        </div>
        <div class="col-md-2 text-right">
            <a href="{{=URL('dashboard')}}" class="btn btn-secondary">← Back</a>
        </div>
    </div>

    {{if timeline_messages:}}
    <div class="card">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">Complete Timeline</h5>
        </div>
        <div class="card-body">
            <div class="timeline-container">
                {{for msg in timeline_messages:}}
                <div class="timeline-entry mb-4 pb-4 border-bottom">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h5>
                            {{if msg.title.startswith('[From Borrower]'):}}
                                <span class="badge badge-info">You</span>
                            {{else:}}
                                <span class="badge badge-primary">MFI</span>
                            {{pass}}
                            {{=msg.title.replace('[From Borrower] ', '')}}
                        </h5>
                        <span class="badge badge-secondary">
                            {{=msg.the_date.strftime('%B %d, %Y')}}
                        </span>
                    </div>
                    {{if msg.the_message:}}
                    <p class="text-muted">{{=msg.the_message}}</p>
                    {{pass}}
                    <small class="text-muted">
                        <i class="far fa-clock"></i>
                        Posted: {{=msg.created_on.strftime('%Y-%m-%d %H:%M')}}
                    </small>
                </div>
                {{pass}}
            </div>
        </div>
    </div>
    {{else:}}
    <div class="alert alert-info">
        <i class="fas fa-info-circle"></i> No timeline messages yet. Your MFI will add updates as your journey progresses.
    </div>
    {{pass}}
</div>

<!-- views/b2c/finances.html -->
{{extend 'layout.html'}}

<div class="container mt-4">
    <div class="row mb-4">
        <div class="col-md-10">
            <h2>Financial Overview</h2>
            <p class="text-muted">Track your loan and repayment details</p>
        </div>
        <div class="col-md-2 text-right">
            <a href="{{=URL('dashboard')}}" class="btn btn-secondary">← Back</a>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body text-center">
                    <h3>{{='%.2f' % (borrower.amount_borrowed or 0)}}</h3>
                    <p class="mb-0">Amount Borrowed</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body text-center">
                    <h3>{{='%.2f' % (borrower.amount_repaid_b2c_reported or 0)}}</h3>
                    <p class="mb-0">Amount Repaid</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card {{='bg-danger' if balance > 0 else 'bg-info'}} text-white">
                <div class="card-body text-center">
                    <h3>{{='%.2f' % balance}}</h3>
                    <p class="mb-0">Balance</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body text-center">
                    <h3>{{='%.0f' % repayment_percentage}}%</h3>
                    <p class="mb-0">Repaid</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Progress Bar -->
    <div class="card mb-4">
        <div class="card-header bg-info text-white">
            <h5 class="mb-0">Repayment Progress</h5>
        </div>
        <div class="card-body">
            <div class="progress" style="height: 40px;">
                <div class="progress-bar {{='bg-success' if repayment_percentage >= 100 else 'bg-info'}}"
                     role="progressbar"
                     style="width: {{='%.1f' % min(repayment_percentage, 100)}}%;">
                    <strong>{{='%.1f' % repayment_percentage}}%</strong>
                </div>
            </div>
        </div>
    </div>

    <!-- MFI Information -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">Your Microfinance Institution</h5>
        </div>
        <div class="card-body">
            <h4>{{=mfi.name}}</h4>
            {{if mfi.contact_person:}}
            <p><strong>Contact Person:</strong> {{=mfi.contact_person}}</p>
            {{pass}}
            {{if mfi.email:}}
            <p><strong>Email:</strong> <a href="mailto:{{=mfi.email}}">{{=mfi.email}}</a></p>
            {{pass}}
            {{if mfi.country:}}
            <p><strong>Country:</strong> {{=mfi.country}}</p>
            {{pass}}
            <a href="{{=URL('contact_mfi')}}" class="btn btn-primary">
                <i class="fas fa-envelope"></i> Contact {{=mfi.name}}
            </a>
        </div>
    </div>
</div>

<!-- views/b2c/contact_mfi.html -->
{{extend 'layout.html'}}

<div class="container mt-4" style="max-width: 700px;">
    <div class="row mb-4">
        <div class="col-md-10">
            <h2>Contact Your MFI</h2>
            <p class="text-muted">Send a message to {{=mfi.name}}</p>
        </div>
        <div class="col-md-2 text-right">
            <a href="{{=URL('dashboard')}}" class="btn btn-secondary btn-sm">← Back</a>
        </div>
    </div>

    <div class="card">
        <div class="card-header bg-info text-white">
            <h5 class="mb-0"><i class="fas fa-envelope"></i> Send Message</h5>
        </div>
        <div class="card-body">
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i>
                <strong>How it works:</strong> Your message will be added to your timeline and your MFI
                will see it when they view your account. They can respond by adding messages to your timeline.
            </div>

            {{=form}}

            <hr>

            <h6>Direct Contact Information:</h6>
            <div class="list-group">
                <div class="list-group-item">
                    <strong>{{=mfi.name}}</strong>
                    {{if mfi.contact_person:}}
                    <br>Contact: {{=mfi.contact_person}}
                    {{pass}}
                    {{if mfi.email:}}
                    <br>Email: <a href="mailto:{{=mfi.email}}">{{=mfi.email}}</a>
                    {{pass}}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- views/b2c/help.html -->
{{extend 'layout.html'}}

<div class="container mt-4">
    <div class="row mb-4">
        <div class="col-md-10">
            <h2>Help & Instructions</h2>
            <p class="text-muted">Learn how to use your WingedFlyer borrower portal</p>
        </div>
        <div class="col-md-2 text-right">
            <a href="{{=URL('dashboard')}}" class="btn btn-secondary">← Dashboard</a>
        </div>
    </div>

    <div class="accordion" id="helpAccordion">
        <!-- Getting Started -->
        <div class="card">
            <div class="card-header" id="headingOne">
                <h5 class="mb-0">
                    <button class="btn btn-link" type="button" data-toggle="collapse" data-target="#collapseOne">
                        <i class="fas fa-play-circle"></i> Getting Started
                    </button>
                </h5>
            </div>
            <div id="collapseOne" class="collapse show" data-parent="#helpAccordion">
                <div class="card-body">
                    <h6>Welcome to WingedFlyer!</h6>
                    <p>This portal helps you manage your microfinance loan and share your journey with supporters.</p>
                    <ul>
                        <li><strong>Login:</strong> Use the username and password provided by your MFI</li>
                        <li><strong>Dashboard:</strong> See your loan status, page views, and recent updates</li>
                        <li><strong>Profile:</strong> Update your contact information and story</li>
                        <li><strong>Micro-Page:</strong> Share your public profile page with supporters</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Using Your Micro-Page -->
        <div class="card">
            <div class="card-header" id="headingTwo">
                <h5 class="mb-0">
                    <button class="btn btn-link collapsed" type="button" data-toggle="collapse" data-target="#collapseTwo">
                        <i class="fas fa-qrcode"></i> Using Your Micro-Page & QR Code
                    </button>
                </h5>
            </div>
            <div id="collapseTwo" class="collapse" data-parent="#helpAccordion">
                <div class="card-body">
                    <h6>Your Public Profile Page</h6>
                    <p>Your micro-page is a public webpage that shows your story, loan progress, and contact info.</p>

                    <h6 class="mt-3">Sharing Your Page:</h6>
                    <ol>
                        <li>Go to "Micro-Page Management" from your dashboard</li>
                        <li>Copy your unique URL or download your QR code</li>
                        <li>Share on social media, print materials, or display at your business</li>
                        <li>People can scan your QR code to visit your page instantly</li>
                    </ol>

                    <h6 class="mt-3">Best Practices:</h6>
                    <ul>
                        <li>Update your story regularly</li>
                        <li>Set your work status daily</li>
                        <li>Print your QR code and display it prominently</li>
                        <li>Share your page link on social media</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Managing Your Profile -->
        <div class="card">
            <div class="card-header" id="headingThree">
                <h5 class="mb-0">
                    <button class="btn btn-link collapsed" type="button" data-toggle="collapse" data-target="#collapseThree">
                        <i class="fas fa-user-edit"></i> Managing Your Profile
                    </button>
                </h5>
            </div>
            <div id="collapseThree" class="collapse" data-parent="#helpAccordion">
                <div class="card-body">
                    <h6>Profile Information</h6>
                    <p>Keep your profile up-to-date so supporters can reach you and follow your progress.</p>

                    <h6 class="mt-3">What You Can Update:</h6>
                    <ul>
                        <li><strong>Contact Info:</strong> Phone, email, address, social media</li>
                        <li><strong>Story:</strong> Tell people about your business and goals</li>
                        <li><strong>Work Status:</strong> Let people know if you're working today</li>
                        <li><strong>Location:</strong> Add your business coordinates</li>
                    </ul>

                    <p class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        Remember: Most profile information is public. Only share what you're comfortable with.
                    </p>
                </div>
            </div>
        </div>

        <!-- Understanding Your Finances -->
        <div class="card">
            <div class="card-header" id="headingFour">
                <h5 class="mb-0">
                    <button class="btn btn-link collapsed" type="button" data-toggle="collapse" data-target="#collapseFour">
                        <i class="fas fa-money-bill-wave"></i> Understanding Your Finances
                    </button>
                </h5>
            </div>
            <div id="collapseFour" class="collapse" data-parent="#helpAccordion">
                <div class="card-body">
                    <h6>Financial Information</h6>
                    <p>Track your loan amount, repayments, and remaining balance.</p>

                    <h6 class="mt-3">Key Terms:</h6>
                    <ul>
                        <li><strong>Amount Borrowed:</strong> Total loan amount from your MFI</li>
                        <li><strong>Amount Repaid:</strong> How much you've paid back so far</li>
                        <li><strong>Balance:</strong> Remaining amount you need to repay</li>
                        <li><strong>Progress:</strong> Percentage of loan repaid</li>
                    </ul>

                    <p class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        Your MFI updates these amounts. Contact them if you have questions about payments.
                    </p>
                </div>
            </div>
        </div>

        <!-- Communication -->
        <div class="card">
            <div class="card-header" id="headingFive">
                <h5 class="mb-0">
                    <button class="btn btn-link collapsed" type="button" data-toggle="collapse" data-target="#collapseFive">
                        <i class="fas fa-comments"></i> Communicating with Your MFI
                    </button>
                </h5>
            </div>
            <div id="collapseFive" class="collapse" data-parent="#helpAccordion">
                <div class="card-body">
                    <h6>Stay Connected</h6>
                    <p>Your MFI can send you updates and important messages through the portal.</p>

                    <h6 class="mt-3">Types of Messages:</h6>
                    <ul>
                        <li><strong>Urgent Messages:</strong> Important alerts displayed prominently</li>
                        <li><strong>Timeline Messages:</strong> Updates about your loan progress</li>
                        <li><strong>Contact Form:</strong> Send messages directly to your MFI</li>
                    </ul>

                    <h6 class="mt-3">How to Contact Your MFI:</h6>
                    <ol>
                        <li>Click "Contact MFI" from the dashboard</li>
                        <li>Fill in the subject and message</li>
                        <li>Your message appears in your timeline</li>
                        <li>Your MFI will respond via timeline or direct contact</li>
                    </ol>
                </div>
            </div>
        </div>

        <!-- Security & Privacy -->
        <div class="card">
            <div class="card-header" id="headingSix">
                <h5 class="mb-0">
                    <button class="btn btn-link collapsed" type="button" data-toggle="collapse" data-target="#collapseSix">
                        <i class="fas fa-shield-alt"></i> Security & Privacy
                    </button>
                </h5>
            </div>
            <div id="collapseSix" class="collapse" data-parent="#helpAccordion">
                <div class="card-body">
                    <h6>Protecting Your Account</h6>

                    <h6 class="mt-3">Password Security:</h6>
                    <ul>
                        <li>Use a strong, unique password</li>
                        <li>Never share your password</li>
                        <li>Change it regularly from "My Profile"</li>
                        <li>Log out when using public computers</li>
                    </ul>

                    <h6 class="mt-3">Privacy Information:</h6>
                    <ul>
                        <li><strong>Public:</strong> Name, contact info, story, loan status</li>
                        <li><strong>Private:</strong> Username, password, page statistics</li>
                    </ul>

                    <p class="alert alert-success">
                        <i class="fas fa-check-circle"></i>
                        Only provide contact information you're comfortable sharing publicly.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Need More Help? -->
    <div class="card mt-4 border-primary">
        <div class="card-body text-center">
            <h5><i class="fas fa-question-circle"></i> Still Need Help?</h5>
            <p class="mb-3">Contact your MFI directly for assistance with your account.</p>
            <a href="{{=URL('contact_mfi')}}" class="btn btn-primary">
                <i class="fas fa-envelope"></i> Contact Your MFI
            </a>
        </div>
    </div>
</div>
