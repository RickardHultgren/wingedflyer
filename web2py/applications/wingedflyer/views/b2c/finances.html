{{extend 'layout.html'}}

<div class="container mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-md-8">
            <h2>My Finances</h2>
            <p class="text-muted">Track your loan and payment history</p>
        </div>
        <div class="col-md-4 text-right">
            <a href="{{=URL('dashboard')}}" class="btn btn-secondary">‚Üê Back to Dashboard</a>
        </div>
    </div>

    <!-- Financial Summary Card -->
    <div class="card mb-4 border-primary">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="fas fa-chart-line"></i> Financial Summary</h5>
        </div>
        <div class="card-body">
            <div class="row text-center mb-4">
                <div class="col-md-4">
                    <div class="p-3 bg-light rounded">
                        <h3 class="mb-1">{{='%.2f' % (borrower.amount_borrowed or 0)}}</h3>
                        <p class="text-muted mb-0">Amount Borrowed</p>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="p-3 bg-light rounded">
                        <h3 class="mb-1">{{='%.2f' % (borrower.amount_repaid_b2c_reported or 0)}}</h3>
                        <p class="text-muted mb-0">Amount Repaid</p>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="p-3 bg-light rounded">
                        <h3 class="mb-1 {{='text-danger' if balance > 0 else 'text-success'}}">
                            {{='%.2f' % balance}}
                        </h3>
                        <p class="text-muted mb-0">Outstanding Balance</p>
                    </div>
                </div>
            </div>

            {{if borrower.amount_borrowed > 0:}}
            <div class="mb-3">
                <label class="form-label"><strong>Repayment Progress</strong></label>
                <div class="progress" style="height: 30px;">
                    <div class="progress-bar bg-success" role="progressbar"
                         style="width: {{='%.1f' % repayment_percentage}}%"
                         aria-valuenow="{{='%.1f' % repayment_percentage}}"
                         aria-valuemin="0"
                         aria-valuemax="100">
                        <strong>{{='%.1f' % repayment_percentage}}% Repaid</strong>
                    </div>
                </div>
            </div>
            {{pass}}

            <div class="row mt-4">
                <div class="col-md-12">
                    <p class="mb-2"><strong>Managed by:</strong> {{=mfi.name}}</p>
                    {{if mfi.telephone:}}
                        <p class="mb-2"><i class="fas fa-phone"></i> {{=mfi.telephone}}</p>
                    {{pass}}
                    {{if mfi.email:}}
                        <p class="mb-2"><i class="fas fa-envelope"></i> {{=mfi.email}}</p>
                    {{pass}}
                </div>
            </div>
        </div>
    </div>

    <!-- Payment Statistics -->
    <div class="card mb-4">
        <div class="card-header bg-info text-white">
            <h5 class="mb-0"><i class="fas fa-calculator"></i> Payment Statistics</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-3 col-6 mb-3">
                    <div class="text-center p-3 bg-light rounded">
                        <h4 class="mb-1 text-primary">{{=total_payments}}</h4>
                        <p class="mb-0 small text-muted">Total Payments</p>
                    </div>
                </div>
                <div class="col-md-3 col-6 mb-3">
                    <div class="text-center p-3 bg-light rounded">
                        <h4 class="mb-1 text-success">{{=on_time_payments}}</h4>
                        <p class="mb-0 small text-muted">On-Time Payments</p>
                    </div>
                </div>
                <div class="col-md-3 col-6 mb-3">
                    <div class="text-center p-3 bg-light rounded">
                        <h4 class="mb-1 text-warning">{{=late_payments}}</h4>
                        <p class="mb-0 small text-muted">Late Payments</p>
                    </div>
                </div>
                <div class="col-md-3 col-6 mb-3">
                    <div class="text-center p-3 bg-light rounded">
                        <h4 class="mb-1 {{='text-success' if on_time_percentage >= 80 else 'text-warning'}}">
                            {{='%.0f' % on_time_percentage}}%
                        </h4>
                        <p class="mb-0 small text-muted">On-Time Rate</p>
                    </div>
                </div>
            </div>

            {{if on_time_percentage >= 90:}}
                <div class="alert alert-success mb-0 mt-3">
                    <i class="fas fa-trophy"></i> <strong>Excellent payment history!</strong> You've maintained a {{='%.0f' % on_time_percentage}}% on-time payment rate.
                </div>
            {{elif on_time_percentage >= 70:}}
                <div class="alert alert-info mb-0 mt-3">
                    <i class="fas fa-check-circle"></i> <strong>Good payment record.</strong> Keep up the consistent payments!
                </div>
            {{pass}}
        </div>
    </div>

    <!-- Complete Payment History -->
    <div class="card mb-4">
        <div class="card-header bg-success text-white">
            <h5 class="mb-0"><i class="fas fa-history"></i> Complete Payment History</h5>
        </div>
        <div class="card-body">
            {{if all_payments:}}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>#</th>
                                <th>Amount</th>
                                <th>Due Date</th>
                                <th>Paid Date</th>
                                <th>Status</th>
                                <th>Payment Method</th>
                                <th>Notes</th>
                            </tr>
                        </thead>
                        <tbody>
                            {{for idx, payment in enumerate(all_payments, 1):}}
                            <tr class="{{='' if payment.paid_date else 'table-warning'}}">
                                <td>{{=idx}}</td>
                                <td><strong>{{='%.2f' % payment.amount}}</strong></td>
                                <td>{{=payment.due_date.strftime('%Y-%m-%d')}}</td>
                                <td>
                                    {{if payment.paid_date:}}
                                        {{=payment.paid_date.strftime('%Y-%m-%d')}}
                                    {{else:}}
                                        <span class="badge bg-warning text-dark">Not Paid</span>
                                    {{pass}}
                                </td>
                                <td>
                                    {{if payment.days_late is not None and payment.paid_date:}}
                                        {{if payment.days_late < 0:}}
                                            <span class="badge bg-success">
                                                <i class="fas fa-check"></i> {{=-payment.days_late}} days early
                                            </span>
                                        {{elif payment.days_late == 0:}}
                                            <span class="badge bg-success">
                                                <i class="fas fa-check"></i> On time
                                            </span>
                                        {{elif payment.days_late <= 3:}}
                                            <span class="badge bg-warning text-dark">
                                                <i class="fas fa-clock"></i> +{{=payment.days_late}} days
                                            </span>
                                        {{else:}}
                                            <span class="badge bg-danger">
                                                <i class="fas fa-exclamation-triangle"></i> +{{=payment.days_late}} days
                                            </span>
                                        {{pass}}
                                    {{elif not payment.paid_date:}}
                                        {{
                                        from datetime import datetime
                                        today = datetime.now().date()
                                        days_overdue = (today - payment.due_date).days
                                        }}
                                        {{if days_overdue > 0:}}
                                            <span class="badge bg-danger">
                                                <i class="fas fa-exclamation-circle"></i> {{=days_overdue}} days overdue
                                            </span>
                                        {{elif days_overdue == 0:}}
                                            <span class="badge bg-warning text-dark">
                                                <i class="fas fa-clock"></i> Due today
                                            </span>
                                        {{else:}}
                                            <span class="badge bg-info">
                                                <i class="fas fa-calendar"></i> Due in {{=-days_overdue}} days
                                            </span>
                                        {{pass}}
                                    {{else:}}
                                        -
                                    {{pass}}
                                </td>
                                <td>
                                    {{if payment.payment_method:}}
                                        <small>{{=payment.payment_method}}</small>
                                    {{else:}}
                                        <span class="text-muted">-</span>
                                    {{pass}}
                                </td>
                                <td>
                                    {{if payment.notes:}}
                                        <small>{{=(payment.notes[:40] + '...') if len(payment.notes) > 40 else payment.notes}}</small>
                                    {{else:}}
                                        <span class="text-muted">-</span>
                                    {{pass}}
                                </td>
                            </tr>
                            {{pass}}
                        </tbody>
                    </table>
                </div>
            {{else:}}
                <div class="text-center py-5">
                    <i class="fas fa-file-invoice-dollar fa-3x text-muted mb-3"></i>
                    <h5>No Payment History Yet</h5>
                    <p class="text-muted">Your payment records will appear here once they're logged by your MFI.</p>
                </div>
            {{pass}}
        </div>
    </div>

    <!-- Financial Timeline -->
    {{if timeline:}}
    <div class="card mb-4">
        <div class="card-header bg-secondary text-white">
            <h5 class="mb-0"><i class="fas fa-timeline"></i> Financial Updates Timeline</h5>
        </div>
        <div class="card-body">
            <div class="list-group">
                {{for msg in timeline:}}
                <div class="list-group-item">
                    <div class="d-flex w-100 justify-content-between">
                        <h6 class="mb-1">{{=msg.title}}</h6>
                        <small class="text-muted">{{=msg.the_date.strftime('%Y-%m-%d')}}</small>
                    </div>
                    {{if msg.the_message:}}
                        <p class="mb-1">{{=msg.the_message}}</p>
                    {{pass}}
                </div>
                {{pass}}
            </div>
        </div>
    </div>
    {{pass}}

    <!-- Important Notice -->
    <div class="card bg-light border-info">
        <div class="card-body">
            <h6><i class="fas fa-info-circle"></i> About Your Financial Information</h6>
            <ul class="mb-0 small">
                <li><strong>Payment records:</strong> Your MFI maintains the official record of payments. This page shows what's been logged in the system.</li>
                <li><strong>Discrepancies:</strong> If you see any difference between what's shown here and your records, please contact your MFI to resolve it.</li>
                <li><strong>Privacy:</strong> Your financial information is only visible to you and your MFI staff. It is never shared without your explicit consent.</li>
                <li><strong>Support offers:</strong> If you're experiencing payment difficulties, your MFI may offer support like payment restructuring. Check your <a href="{{=URL('support_offers')}}">Support Offers</a> page.</li>
            </ul>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="card mt-4 bg-light">
        <div class="card-body">
            <h6>Quick Actions</h6>
            <div class="row">
                <div class="col-md-4 mb-2">
                    <a href="{{=URL('support_offers')}}" class="btn btn-outline-primary btn-block w-100">
                        <i class="fas fa-handshake"></i> View Support Offers
                    </a>
                </div>
                <div class="col-md-4 mb-2">
                    <a href="{{=URL('timeline')}}" class="btn btn-outline-info btn-block w-100">
                        <i class="fas fa-list"></i> Complete Timeline
                    </a>
                </div>
                <div class="col-md-4 mb-2">
                    <a href="{{=URL('dashboard')}}" class="btn btn-outline-secondary btn-block w-100">
                        <i class="fas fa-home"></i> Back to Dashboard
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .card {
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .progress {
        font-size: 1rem;
    }

    .table thead th {
        border-bottom: 2px solid #dee2e6;
        font-weight: 600;
    }

    .table-hover tbody tr:hover {
        background-color: #f8f9fa;
    }

    .bg-light {
        background-color: #f8f9fa !important;
    }

    .rounded {
        border-radius: 0.5rem !important;
    }

    @media (max-width: 768px) {
        .text-right {
            text-align: left !important;
            margin-top: 1rem;
        }

        .table {
            font-size: 0.85rem;
        }

        .table th,
        .table td {
            padding: 0.5rem;
        }
    }

    /* Print styles */
    @media print {
        .btn, .card-header {
            display: none;
        }

        .card {
            box-shadow: none;
            border: 1px solid #000;
        }
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Add print functionality
    const printButton = document.createElement('button');
    printButton.className = 'btn btn-outline-secondary btn-sm float-end';
    printButton.innerHTML = '<i class="fas fa-print"></i> Print';
    printButton.onclick = function() {
        window.print();
    };

    // Optionally add to header
    // document.querySelector('.container .row').appendChild(printButton);
});
</script>
