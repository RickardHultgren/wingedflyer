{{extend 'layout.html'}}

<div class="container mt-3">
    <div class="row">
        <div class="col-md-3">
            <div class="card">
                <div class="card-header">
                    <h5>Your Flyers</h5>
                </div>
                <div class="list-group list-group-flush">
                    <a href="{{=URL('editor')}}"
                       class="list-group-item list-group-item-action {{='active' if not current_flyer else ''}}">
                        â• New Flyer
                    </a>
                    
                    {{for flyer in flyers:}}
                    <a href="{{=URL('editor', args=[flyer.id])}}"
                       class="list-group-item list-group-item-action {{='active' if current_flyer and current_flyer.id == flyer.id else ''}}">
                        {{=flyer.title}}
                    </a>
                    {{pass}}
                </div>
            </div>
            
            <!-- Debug info -->
            <div class="card mt-3">
                <div class="card-body">
                    <small class="text-muted">
                        <strong>Debug:</strong><br>
                        B2C ID: {{=b2c_id}}<br>
                        Current Flyer: {{='Yes (ID: %s)' % current_flyer.id if current_flyer else 'No (New)'}}<br>
                        Total Flyers: {{=len(flyers)}}
                    </small>
                </div>
            </div>
        </div>

        <div class="col-md-9">
            <div class="card">
                <div class="card-header">
                    <h4>{{='Edit Flyer #%s' % current_flyer.id if current_flyer else 'Create New Flyer'}}</h4>
                </div>
                <div class="card-body">

                    {{if session.flash:}}
                        <div class="alert alert-info alert-dismissible fade show">
                            {{=session.flash}}
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    {{pass}}

                    <form action="{{=URL('save')}}" method="post" id="flyerForm">
                        <input type="hidden" name="id" value="{{=current_flyer.id if current_flyer else ''}}" id="flyerId">

                        <div class="mb-3">
                            <label class="form-label">Title *</label>
                            <input class="form-control" 
                                   name="title" 
                                   id="flyerTitle"
                                   value="{{=current_flyer.title if current_flyer else ''}}"
                                   placeholder="My Flyer Title" 
                                   required>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">
                                Content (Markdown) *
                                <a href="https://www.markdownguide.org/cheat-sheet/"
                                   target="_blank"
                                   class="small text-muted">(Guide)</a>
                            </label>
                            <textarea name="thecontent" 
                                      id="flyerContent"
                                      class="form-control font-monospace"
                                      rows="15"
                                      placeholder="# Heading&#10;Your content here..."
                                      required>{{=current_flyer.thecontent if current_flyer else ''}}</textarea>
                        </div>

                        {{if current_flyer and current_flyer.updated_on:}}
                            <div class="mb-3">
                                <small class="text-muted">
                                    Last updated: {{=current_flyer.updated_on.strftime('%Y-%m-%d %H:%M')}}<br>
                                    View count: {{=current_flyer.view_count or 0}}
                                </small>
                            </div>
                        {{pass}}

                        <div class="btn-group" role="group">
                            <button type="submit" class="btn btn-primary" id="saveBtn">ğŸ’¾ Save</button>

                            {{if current_flyer:}}
                                <a href="{{=URL('preview', args=[current_flyer.id])}}"
                                   class="btn btn-secondary">ğŸ‘ï¸ Preview</a>

                                <a href="{{=URL('view_b2c', args=[current_flyer.id])}}"
                                   class="btn btn-info" target="_blank">ğŸŒ Public View</a>

                                <a href="{{=URL('qr', args=[current_flyer.id])}}"
                                   class="btn btn-success" target="_blank">ğŸ“± QR Code</a>

                                <a href="{{=URL('delete', args=[current_flyer.id])}}"
                                   class="btn btn-danger"
                                   onclick="return confirm('Delete this flyer?')">ğŸ—‘ï¸ Delete</a>
                            {{pass}}
                        </div>

                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Debug: Log form submission
document.getElementById('flyerForm').addEventListener('submit', function(e) {
    console.log('=== FORM SUBMITTING ===');
    console.log('ID:', document.getElementById('flyerId').value);
    console.log('Title:', document.getElementById('flyerTitle').value);
    console.log('Content length:', document.getElementById('flyerContent').value.length);
    console.log('Action:', this.action);
    console.log('Method:', this.method);
    // Form will submit normally
});
</script>
