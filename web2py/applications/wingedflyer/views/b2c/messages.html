{{extend 'layout.html'}}

<div class="container mt-4">
    <div class="row mb-4">
        <div class="col-md-8">
            <h2><i class="fa fa-envelope-open"></i> My Messages</h2>
            <p class="text-muted">Important updates from {{=mfi.name if mfi else 'your MFI'}}</p>
        </div>
        <div class="col-md-4 text-right">
            <a href="{{=URL('dashboard')}}" class="btn btn-secondary">Back to Dashboard</a>
        </div>
    </div>

    <div class="card shadow-sm">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="bg-light">
                        <tr>
                            <th style="width: 50px;">Status</th>
                            <th>Subject</th>
                            <th>Date Received</th>
                            <th>Your Response</th>
                            <th class="text-right">Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {{if not messages:}}
                        <tr>
                            <td colspan="5" class="text-center py-5 text-muted">
                                <h5>No messages found.</h5>
                                <p>You will see communications from your MFI here.</p>
                            </td>
                        </tr>
                        {{else:}}
                            {{for row in messages:}}
                            {{msg = row.mfi_info_flyer}}
                            {{recipient_record = row.info_flyer_recipient}}
                            <tr class="{{='table-warning' if not recipient_record.is_read else ''}}">
                                <td class="text-center">
                                    {{if not recipient_record.is_read:}}
                                        <span class="badge bg-primary">New</span>
                                    {{else:}}
                                        <i class="fa fa-check text-success" title="Read"></i>
                                    {{pass}}
                                </td>
                                <td>
                                    <strong>{{=msg.subject}}</strong>
                                    {{if msg.response_template != 'NONE' and not recipient_record.response:}}
                                        <br><small class="text-danger"><i class="fa fa-exclamation-circle"></i> Response Required</small>
                                    {{pass}}
                                </td>
                                <td>
                                    {{=msg.created_on.strftime('%Y-%m-%d %H:%M')}}
                                </td>
                                <td>
                                    {{if recipient_record.response:}}
                                        <span class="text-success"><i class="fa fa-reply"></i> {{=recipient_record.response[:30]}}...</span>
                                    {{elif msg.response_template == 'NONE':}}
                                        <span class="text-muted">No response needed</span>
                                    {{else:}}
                                        <span class="text-warning">Pending...</span>
                                    {{pass}}
                                </td>
                                <td class="text-right">
                                    <a href="{{=URL('view_message', args=[recipient_record.id])}}" 
                                       class="btn btn-sm {{='btn-primary' if not recipient_record.is_read else 'btn-outline-primary'}}">
                                        {{='Open Message' if not recipient_record.is_read else 'Read Again'}}
                                    </a>
                                </td>
                            </tr>
                            {{pass}}
                        {{pass}}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<style>
    .table-warning { background-color: rgba(255, 193, 7, 0.05) !important; }
    .text-right { text-align: right; }
    .badge { font-weight: 500; }
    .fa-reply { transform: scaleX(-1); } /* Flip reply icon to point left */
</style>
