{{extend 'layout.html'}}

<div class="container mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-md-8">
            <h2>Record Today's Signals</h2>
            <p class="text-muted">How did your work activities go today?</p>
        </div>
        <div class="col-md-4 text-right">
            <a href="{{=URL('dashboard')}}" class="btn btn-secondary">← Back to Dashboard</a>
        </div>
    </div>

    <!-- Flash Messages -->
    {{if session.flash:}}
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        {{=session.flash}}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {{pass}}

    <!-- What Signals Mean -->
    <div class="alert alert-info">
        <h5><i class="fas fa-info-circle"></i> What Are Signals?</h5>
        <p class="mb-2">Signals are a simple way to let your MFI know how your work is going. For each of your activities, you choose one of three options:</p>
        <div class="row text-center mb-2">
            <div class="col-md-4">
                <span class="badge bg-success fs-6 p-2 w-100">Better than expected</span>
                <p class="small mt-1 mb-0">Things went better than you planned</p>
            </div>
            <div class="col-md-4">
                <span class="badge bg-secondary fs-6 p-2 w-100">As expected</span>
                <p class="small mt-1 mb-0">Things went according to plan</p>
            </div>
            <div class="col-md-4">
                <span class="badge bg-warning text-dark fs-6 p-2 w-100">Worse than expected</span>
                <p class="small mt-1 mb-0">Things encountered friction or problems</p>
            </div>
        </div>
        <p class="mb-0"><small><i class="fas fa-shield-alt"></i> <strong>Important:</strong> These signals are for coordination, not judgment. Your MFI sees them to understand when they might be able to help, not to evaluate how hard you're working.</small></p>
    </div>

    <!-- Already Signaled Today -->
    {{if today_signals:}}
    <div class="card mb-4 border-success">
        <div class="card-header bg-success text-white">
            <h5 class="mb-0"><i class="fas fa-check-circle"></i> Signals Recorded Today</h5>
        </div>
        <div class="card-body">
            <p class="mb-3">You've already recorded these signals today:</p>
            <div class="list-group">
                {{for signal in today_signals:}}
                {{
                activity = db.work_activity(signal.work_activity_id)
                }}
                <div class="list-group-item">
                    <div class="d-flex w-100 justify-content-between align-items-center">
                        <div class="flex-grow-1">
                            <h6 class="mb-1">{{=activity.activity_name if activity else 'Unknown Activity'}}</h6>
                            {{if signal.note:}}
                                <small class="text-muted">Note: {{=signal.note}}</small>
                            {{pass}}
                        </div>
                        <div class="d-flex align-items-center gap-2">
                            <span class="badge {{='bg-success' if signal.outcome == 'BETTER' else ('bg-secondary' if signal.outcome == 'AS_EXPECTED' else 'bg-warning text-dark')}} fs-6">
                                {{='Better' if signal.outcome == 'BETTER' else ('As Expected' if signal.outcome == 'AS_EXPECTED' else 'Worse')}}
                            </span>
                            <a href="{{=URL('delete_signal', args=[signal.id])}}"
                               class="btn btn-sm btn-outline-danger"
                               onclick="return confirm('Delete this signal? You will be able to record a new one.');"
                               title="Delete and re-record">
                                <i class="fas fa-trash"></i>
                            </a>
                        </div>
                    </div>
                </div>
                {{pass}}
            </div>
            <div class="alert alert-light mt-3 mb-0">
                <small><i class="fas fa-calendar-check"></i> You can record one signal per activity per day. If you need to change a signal, delete it and record a new one. Visit your <a href="{{=URL('signal_history')}}">signal history</a> to see past records.</small>
            </div>
        </div>
    </div>
    {{pass}}

    <!-- Signal Recording Forms -->
    {{if forms:}}
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="fas fa-signal"></i> Record Your Signals</h5>
        </div>
        <div class="card-body">
            <p class="text-muted mb-4">For each activity below, signal how things went today. You can add an optional note if you want to provide context.</p>

            {{for activity, form in forms:}}
            <div class="activity-form-section p-3 mb-3 border rounded">
                <h5 class="mb-3">
                    <i class="fas fa-tasks text-primary"></i> {{=activity.activity_name}}
                </h5>
                {{if activity.description:}}
                    <p class="text-muted small mb-3"><em>{{=activity.description}}</em></p>
                {{pass}}

                <div class="signal-form">
                    {{=form}}
                </div>
            </div>
            {{pass}}

            <div class="alert alert-warning mt-4 mb-0">
                <h6><i class="fas fa-lightbulb"></i> Tips for Honest Signaling</h6>
                <ul class="small mb-0">
                    <li><strong>Be honest:</strong> There's no penalty for signaling "worse than expected" – it just helps your MFI know when they might be able to offer support</li>
                    <li><strong>Think about your plan:</strong> Compare today against what you expected, not against some ideal outcome</li>
                    <li><strong>Context helps:</strong> If you signal "worse," a brief note about what happened (e.g., "supplier prices up") helps your MFI offer relevant support</li>
                    <li><strong>It's your judgment:</strong> Only you know what "better," "as expected," or "worse" means for your work</li>
                </ul>
            </div>
        </div>
    </div>

    {{elif not today_signals:}}
    <!-- No Activities Defined -->
    <div class="card mb-4 border-warning">
        <div class="card-header bg-warning text-dark">
            <h5 class="mb-0"><i class="fas fa-exclamation-triangle"></i> No Activities to Signal</h5>
        </div>
        <div class="card-body text-center py-5">
            <i class="fas fa-tasks fa-4x text-muted mb-3"></i>
            <h5>You need to define your work activities first</h5>
            <p class="text-muted mb-3">Before you can record daily signals, you need to define the work activities that matter for your business.</p>
            <a href="{{=URL('my_activities')}}" class="btn btn-primary btn-lg">
                <i class="fas fa-plus-circle"></i> Define My Work Activities
            </a>
        </div>
    </div>
    {{pass}}

    <!-- How Your MFI Uses Signals -->
    <div class="card border-info mb-4">
        <div class="card-header bg-info text-white">
            <h5 class="mb-0"><i class="fas fa-handshake"></i> How Your MFI Uses Your Signals</h5>
        </div>
        <div class="card-body">
            <p class="mb-3">Your signals help your MFI understand when they might be able to offer support. Here's what happens:</p>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <div class="card h-100 bg-light">
                        <div class="card-body">
                            <h6><i class="fas fa-eye text-primary"></i> What Your MFI Sees</h6>
                            <ul class="small mb-0">
                                <li>Your signal outcomes (better/as expected/worse)</li>
                                <li>Any notes you choose to include</li>
                                <li>Patterns over time (e.g., multiple "worse" signals)</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="col-md-6 mb-3">
                    <div class="card h-100 bg-light">
                        <div class="card-body">
                            <h6><i class="fas fa-hands-helping text-success"></i> What They Can Do</h6>
                            <ul class="small mb-0">
                                <li>Create support offers you can accept or decline</li>
                                <li>Share information about resources</li>
                                <li>Offer payment timing adjustments</li>
                                <li>Connect you to services that might help</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <div class="card h-100 bg-light">
                        <div class="card-body">
                            <h6><i class="fas fa-times-circle text-danger"></i> What They Cannot Do</h6>
                            <ul class="small mb-0">
                                <li>Judge your effort or work ethic</li>
                                <li>Penalize you for honest signals</li>
                                <li>Act without your consent</li>
                                <li>Make decisions about your creditworthiness based solely on signals</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="col-md-6 mb-3">
                    <div class="card h-100 bg-light">
                        <div class="card-body">
                            <h6><i class="fas fa-shield-alt text-info"></i> Your Protections</h6>
                            <ul class="small mb-0">
                                <li>All MFI actions are offers, not commands</li>
                                <li>You can accept, decline, or modify any offer</li>
                                <li>Your autonomy is always protected</li>
                                <li>Signals are for coordination, not control</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <div class="alert alert-light mb-0 mt-3">
                <small><i class="fas fa-balance-scale"></i> <strong>The design principle:</strong> This system is built to enable partnership between you and your MFI, not to enable surveillance. Your MFI learns about constraints you're facing so they can <em>offer</em> help—but you remain in control of all decisions.</small>
            </div>
        </div>
    </div>

    <!-- Recent Signal History -->
    <div class="card mb-4 bg-light">
        <div class="card-body">
            <h6><i class="fas fa-history"></i> View Your Signal History</h6>
            <p class="mb-3">Want to see your past signals? You can review your complete signaling history to see patterns and track how things have been going.</p>
            <a href="{{=URL('signal_history')}}" class="btn btn-outline-secondary">
                <i class="fas fa-chart-line"></i> View Signal History
            </a>
            <a href="{{=URL('my_activities')}}" class="btn btn-outline-primary">
                <i class="fas fa-cog"></i> Manage Activities
            </a>
        </div>
    </div>

    <!-- Privacy Notice -->
    <div class="alert alert-secondary">
        <small class="text-muted">
            <i class="fas fa-lock"></i> <strong>Privacy:</strong> Your signals are only visible to you and authorized staff at your MFI. They are never shared with third parties without your explicit consent. Your signals are stored to help coordinate support, not to build a performance record.
        </small>
    </div>
</div>

<style>
    .card {
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .activity-form-section {
        background-color: #f8f9fa;
        transition: all 0.3s;
    }

    .activity-form-section:hover {
        background-color: #e9ecef;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .signal-form .form-group {
        margin-bottom: 1rem;
    }

    .signal-form label {
        font-weight: 600;
        color: #495057;
    }

    .signal-form select {
        font-size: 1rem;
        padding: 0.75rem;
    }

    .signal-form textarea {
        min-height: 80px;
    }

    .signal-form button[type="submit"] {
        font-weight: 600;
        padding: 0.75rem 1.5rem;
    }

    .badge {
        font-weight: 600;
    }

    .fs-6 {
        font-size: 1rem !important;
    }

    .gap-2 {
        gap: 0.5rem;
    }

    @media (max-width: 768px) {
        .text-right {
            text-align: left !important;
            margin-top: 1rem;
        }

        .activity-form-section {
            padding: 1rem !important;
        }
    }

    /* Make form more visually appealing */
    .signal-form select.form-control {
        border: 2px solid #dee2e6;
        border-radius: 0.5rem;
        transition: all 0.2s;
    }

    .signal-form select.form-control:focus {
        border-color: #0d6efd;
        box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
    }

    .signal-form textarea.form-control {
        border: 2px solid #dee2e6;
        border-radius: 0.5rem;
        transition: all 0.2s;
    }

    .signal-form textarea.form-control:focus {
        border-color: #0d6efd;
        box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
    }

    /* Success feedback animation */
    @keyframes successPulse {
        0% {
            transform: scale(1);
        }
        50% {
            transform: scale(1.05);
        }
        100% {
            transform: scale(1);
        }
    }

    .alert-success {
        animation: successPulse 0.5s ease-in-out;
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Auto-dismiss flash messages
    setTimeout(function() {
        const alerts = document.querySelectorAll('.alert-success.alert-dismissible');
        alerts.forEach(function(alert) {
            alert.style.transition = 'opacity 0.5s';
            alert.style.opacity = '0';
            setTimeout(function() {
                alert.remove();
            }, 500);
        });
    }, 3000);

    // Add helpful tooltips to outcome options
    const selectElements = document.querySelectorAll('.signal-form select');
    selectElements.forEach(function(select) {
        select.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            const value = selectedOption.value;

            // Optional: provide visual feedback based on selection
            if (value === 'WORSE') {
                this.style.borderColor = '#ffc107';
            } else if (value === 'BETTER') {
                this.style.borderColor = '#28a745';
            } else {
                this.style.borderColor = '#6c757d';
            }
        });
    });

    // Add confirmation before leaving if forms are filled
    let formsModified = false;
    const formInputs = document.querySelectorAll('.signal-form input, .signal-form select, .signal-form textarea');

    formInputs.forEach(function(input) {
        input.addEventListener('change', function() {
            formsModified = true;
        });
    });

    window.addEventListener('beforeunload', function(e) {
        if (formsModified) {
            const confirmationMessage = 'You have unsaved signals. Are you sure you want to leave?';
            e.returnValue = confirmationMessage;
            return confirmationMessage;
        }
    });

    // Reset the flag when a form is submitted
    const forms = document.querySelectorAll('.signal-form form');
    forms.forEach(function(form) {
        form.addEventListener('submit', function() {
            formsModified = false;
        });
    });
});
</script>
