{{extend 'layout.html'}}

<script>
jQuery(document).ready(function(){
    jQuery("table.sortable tbody tr").mouseover(function() {
        jQuery(this).addClass("highlight");
    }).mouseout(function() {
        jQuery(this).removeClass("highlight");
    });
    jQuery('table.sortable tbody tr:odd').addClass('odd');
    jQuery('table.sortable tbody tr:even').addClass('even');
});
</script>

<div class="row">
  <div class="col-md-12">

  {{if request.function=='index':}}
    <h2>{{=T("Database Administration")}}</h2>
    
    <div class="alert alert-info">
      <strong>{{=T("Responsible Management:")}}</strong> 
      {{=T("Manage entities (MFIs, Coaching Orgs, etc.) and their operational contexts.")}}
    </div>

    <div class="my-3">
      <a class="btn btn-success btn-lg" href="{{=URL('responsiblelist')}}">
        <i class="glyphicon glyphicon-list"></i> {{=T("View All Responsibles")}}
      </a>
      <a class="btn btn-primary btn-lg" href="{{=URL('responsiblecreate')}}">
        <i class="glyphicon glyphicon-plus"></i> {{=T("Add New Responsible")}}
      </a>
      <a class="btn btn-info btn-lg" href="{{=URL('manage_language')}}">
        <i class="glyphicon glyphicon-globe"></i> {{=T("Manage Language Mappings")}}

      {{if 'databases' in globals():}}
        <table class="table table-striped">
            {{for db_name in sorted(databases):}}
                {{for table in databases[db_name].tables:}}
                <tr>
                    <td style="vertical-align: middle;"><strong>{{=table}}</strong></td>
                    <td class="text-right">
                        <a href="{{=URL('select', args=[db_name], vars=dict(query='%s.%s.id>0' % (db_name, table)))}}" class="btn btn-sm btn-default">
                           <i class="glyphicon glyphicon-search"></i> {{=T('view rows')}}
                        </a>
                        <a href="{{=URL('insert', args=[db_name, table])}}" class="btn btn-sm btn-success">
                           <i class="glyphicon glyphicon-plus"></i> {{=T('insert new')}}
                        </a>
                    </td>
                </tr>
                {{pass}}
            {{pass}}
        </table>
      {{pass}}  
      </a>
    </div>

    <hr/>
    <h3>{{=T("Available Databases and Tables")}}</h3>
    {{if 'databases' in globals():}}
        <table class="table table-striped">
            {{for db_name in sorted(databases):}}
                {{for table in databases[db_name].tables:}}
                <tr>
                    <td>{{=db_name}}.{{=table}}</td>
                    <td class="text-right">
                        <a href="{{=URL('select', args=[db_name], vars=dict(query='%s.%s.id>0' % (db_name, table)))}}" class="btn btn-sm btn-default">{{=T('view rows')}}</a>
                    </td>
                </tr>
                {{pass}}
            {{pass}}
        </table>
    {{pass}}

  {{elif request.function=='responsiblelist':}}
    <h2>{{=T("Responsible Entities")}}</h2>
    {{if 'error' in globals() and error:}}
      <div class="alert alert-danger">{{=error}}</div>
    {{elif rows:}}
      <div class="table-responsive">
        <table class="table table-striped table-bordered table-hover sortable">
          <thead class="thead-dark">
            <tr>
              <th>{{=T("Name")}}</th>
              <th>{{=T("Context")}}</th>
              <th>{{=T("Username")}}</th>
              <th>{{=T("Country")}}</th>
              <th>{{=T("Email")}}</th>
              <th>{{=T("Limit")}}</th>
              <th>{{=T("Created On")}}</th>
              <th style="width: 120px;">{{=T("Actions")}}</th>
            </tr>
          </thead>
          <tbody>
            {{for row in rows:}}
              <tr>
                <td><strong>{{=row.responsible.name}}</strong></td>
                <td><span class="label label-info">{{=row.context.display_name}}</span></td>
                <td><code>{{=row.responsible.username}}</code></td>
                <td>{{=row.responsible.country or T('N/A')}}</td>
                <td>{{=row.responsible.email or T('N/A')}}</td>
                <td><span class="badge">{{=row.responsible.participant_limit}}</span></td>
                <td>{{=row.responsible.created_on.strftime('%Y-%m-%d') if row.responsible.created_on else T('N/A')}}</td>
                <td>
                  <a class="btn btn-sm btn-primary" href="{{=URL('responsibleedit', args=[row.responsible.id])}}">
                    <i class="glyphicon glyphicon-edit"></i> {{=T("Edit")}}
                  </a>
                </td>
              </tr>
            {{pass}}
          </tbody>
        </table>
      </div>
    {{pass}}

    <div class="my-3">
      <a class="btn btn-success" href="{{=URL('responsiblecreate')}}">{{=T("Add New Responsible")}}</a>
      <a class="btn btn-secondary" href="{{=URL('index')}}">{{=T("Back to Admin")}}</a>
    </div>

  {{elif request.function=='responsibleedit':}}
    <h2>{{=T("Edit Responsible Entity")}}</h2>
    {{if record:}}
      <div class="alert alert-info">
        <strong>{{=T("Context:")}}</strong> {{=context_name}} | 
        <strong>{{=T("Participants:")}}</strong> <span class="badge">{{=participant_count}}</span>
      </div>
      <div class="panel panel-default">
        <div class="panel-body">{{=form}}</div>
      </div>
    {{pass}}
    <a class="btn btn-secondary" href="{{=URL('responsiblelist')}}">{{=T("Back to List")}}</a>

  {{elif request.function=='responsiblecreate':}}
    <h2>{{=T("Register New Responsible Entity")}}</h2>
    <div class="panel panel-primary">
      <div class="panel-body">{{=form}}</div>
    </div>
    <a class="btn btn-secondary" href="{{=URL('responsiblelist')}}">{{=T("Back to List")}}</a>

  {{elif request.function == 'manage_language':}}
      <div class="row">
          <div class="col-md-9">
              <h2><i class="glyphicon glyphicon-globe"></i> {{=T("Feature Language Mappings")}}</h2>
              <p class="text-muted">
                  {{=T("Define how features are named for different organizational contexts (e.g., 'Borrower' for MFIs vs 'Coachee' for Coaching).")}}
              </p>
          </div>
          <div class="col-md-3 text-right" style="padding-top: 25px;">
              <a class="btn btn-default" href="{{=URL('index')}}">
                  <i class="glyphicon glyphicon-arrow-left"></i> {{=T("Back to Admin")}}
                </a>
          </div>
      </div>

      <div class="panel panel-default" style="margin-top: 20px;">
        <div class="panel-heading">
            <h3 class="panel-title">{{=T("Translation Dictionary")}}</h3>
        </div>
        <div class="panel-body">
          <div class="alert alert-warning" style="font-size: 0.9em;">
            <i class="glyphicon glyphicon-info-sign"></i> 
            <strong>{{=T("Formatting Guide:")}}</strong> 
            <code>label</code> (Singular), <code>label_plural</code> (Plural), <code>call_to_action</code> (Buttons).
          </div>
          
          <div class="web2py_grid">
              {{=grid}}
          </div>
        </div>
      </div>

      <style>
          /* Specific tweaks for the Grid UI within this view */
          .web2py_grid table { margin-bottom: 0; }
          .web2py_grid .web2py_console { margin-bottom: 15px; }
          .web2py_grid .btn { margin-right: 5px; }
          .label-info { font-size: 0.9em; }
      </style>
  {{elif request.function in ['select', 'insert', 'update']:}}
    <h2>{{=T("Database Task:")}} {{=request.function.capitalize()}}</h2>
    <div class="well">
        {{=form if 'form' in globals() else ''}}
        {{=grid if 'grid' in globals() else ''}}
        {{=rows if 'rows' in globals() and not isinstance(rows, list) else ''}}
    </div>
    <a class="btn btn-secondary" href="{{=URL('index')}}">{{=T("Back to Admin")}}</a>

  {{pass}}

  </div>
</div>