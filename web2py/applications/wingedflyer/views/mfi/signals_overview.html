{{extend 'layout.html'}}

<div class="container mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-md-8">
            <h2>Borrower Signals Overview</h2>
            <p class="text-muted">View signals from all borrowers (last 7 days)</p>
        </div>
        <div class="col-md-4 text-right">
            <a href="{{=URL('dashboard')}}" class="btn btn-secondary">‚Üê Back to Dashboard</a>
        </div>
    </div>

    <!-- Important Reminder -->
    <div class="alert alert-warning">
        <h6><i class="fas fa-exclamation-triangle"></i> Remember: Signals Are Not Scores</h6>
        <p class="mb-0 small">
            These signals show how borrowers' work is going according to <strong>their own plans and expectations</strong>. 
            They are for coordination and support, not for judging effort or productivity. 
            When you see patterns that suggest you might be able to help, send a info_flyer or offer support‚Äîdon't make unilateral decisions.
        </p>
    </div>

    <!-- Summary Statistics -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card bg-light">
                <div class="card-body text-center">
                    <h2 class="mb-1">{{=len(all_signals)}}</h2>
                    <p class="text-muted mb-0">Total Signals (7 days)</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card bg-success text-white">
                <div class="card-body text-center">
                    <h2 class="mb-1">{{=len(better_signals)}}</h2>
                    <p class="mb-0">Better Than Expected</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card bg-warning text-dark">
                <div class="card-body text-center">
                    <h2 class="mb-1">{{=len(worse_signals)}}</h2>
                    <p class="mb-0">Worse Than Expected</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Filter Tabs -->
    <ul class="nav nav-tabs mb-3" id="signalTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="all-tab" data-bs-toggle="tab" data-bs-target="#all" type="button">
                All Signals ({{=len(all_signals)}})
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="worse-tab" data-bs-toggle="tab" data-bs-target="#worse" type="button">
                üü° Worse ({{=len(worse_signals)}})
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="better-tab" data-bs-toggle="tab" data-bs-target="#better" type="button">
                üü¢ Better ({{=len(better_signals)}})
            </button>
        </li>
    </ul>

    <div class="tab-content" id="signalTabsContent">
        <!-- All Signals Tab -->
        <div class="tab-pane fade show active" id="all" role="tabpanel">
            {{if all_signals:}}
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">All Signals</h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Borrower</th>
                                        <th>Activity</th>
                                        <th>Outcome</th>
                                        <th>Note</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {{for signal in all_signals:}}
                                    <tr>
                                        <td>{{=signal.daily_signal.signal_date.strftime('%Y-%m-%d')}}</td>
                                        <td>
                                            <strong>{{=signal.b2c.real_name}}</strong>
                                            <br><small class="text-muted">{{=signal.b2c.username}}</small>
                                        </td>
                                        <td>{{=signal.work_activity.activity_name if signal.work_activity else 'Unknown'}}</td>
                                        <td>
                                            {{if signal.daily_signal.outcome == 'BETTER':}}
                                                <span class="badge bg-success">Better</span>
                                            {{elif signal.daily_signal.outcome == 'AS_EXPECTED':}}
                                                <span class="badge bg-secondary">As Expected</span>
                                            {{else:}}
                                                <span class="badge bg-warning text-dark">Worse</span>
                                            {{pass}}
                                        </td>
                                        <td>
                                            {{if signal.daily_signal.note:}}
                                                <small>{{=signal.daily_signal.note[:60] + ('...' if len(signal.daily_signal.note) > 60 else '')}}</small>
                                            {{else:}}
                                                <span class="text-muted">-</span>
                                            {{pass}}
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                <a href="{{=URL('b2c', args=[signal.b2c.id])}}" 
                                                   class="btn btn-outline-primary btn-sm"
                                                   title="View Borrower">
                                                    <i class="fas fa-user"></i>
                                                </a>
                                                <a href="{{=URL('compose_info_flyer', args=[signal.b2c.id])}}" 
                                                   class="btn btn-outline-success btn-sm"
                                                   title="Send info_flyer">
                                                    <i class="fas fa-envelope"></i>
                                                </a>
                                            </div>
                                        </td>
                                    </tr>
                                    {{pass}}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            {{else:}}
                <div class="card">
                    <div class="card-body text-center py-5">
                        <i class="fas fa-signal fa-3x text-muted mb-3"></i>
                        <h5>No Signals in Last 7 Days</h5>
                        <p class="text-muted">Borrowers haven't recorded any signals recently.</p>
                    </div>
                </div>
            {{pass}}
        </div>

        <!-- Worse Signals Tab -->
        <div class="tab-pane fade" id="worse" role="tabpanel">
            {{if worse_signals:}}
                <div class="alert alert-info">
                    <h6><i class="fas fa-info-circle"></i> About "Worse" Signals</h6>
                    <p class="mb-0 small">
                        These signals indicate things didn't go as the borrower expected. This could be due to external factors 
                        (weather, supply issues, market conditions) or coordination needs. Consider whether you can offer support 
                        through information sharing, resource connections, or timing adjustments.
                    </p>
                </div>

                <div class="card">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0">Signals: Worse Than Expected</h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Borrower</th>
                                        <th>Activity</th>
                                        <th>Note</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {{for signal in worse_signals:}}
                                    <tr>
                                        <td>{{=signal.daily_signal.signal_date.strftime('%Y-%m-%d')}}</td>
                                        <td>
                                            <strong>{{=signal.b2c.real_name}}</strong>
                                            <br><small class="text-muted">{{=signal.b2c.username}}</small>
                                        </td>
                                        <td>{{=signal.work_activity.activity_name if signal.work_activity else 'Unknown'}}</td>
                                        <td>
                                            {{if signal.daily_signal.note:}}
                                                <small><strong>{{=signal.daily_signal.note}}</strong></small>
                                            {{else:}}
                                                <span class="text-muted">No note provided</span>
                                            {{pass}}
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                <a href="{{=URL('b2c', args=[signal.b2c.id])}}" 
                                                   class="btn btn-outline-primary btn-sm"
                                                   title="View Borrower">
                                                    <i class="fas fa-user"></i>
                                                </a>
                                                <a href="{{=URL('compose_info_flyer', args=[signal.b2c.id])}}" 
                                                   class="btn btn-outline-success btn-sm"
                                                   title="Send info_flyer">
                                                    <i class="fas fa-envelope"></i>
                                                </a>
                                            </div>
                                        </td>
                                    </tr>
                                    {{pass}}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Pattern Analysis -->
                {{
                # Analyze patterns: which borrowers have multiple "worse" signals
                from collections import Counter
                borrower_worse_counts = Counter([s.b2c.id for s in worse_signals])
                repeated_worse = [(bid, count) for bid, count in borrower_worse_counts.items() if count > 2]
                }}

                {{if repeated_worse:}}
                <div class="card mt-3 border-warning">
                    <div class="card-header bg-warning text-dark">
                        <h6 class="mb-0"><i class="fas fa-exclamation-circle"></i> Borrowers with Multiple "Worse" Signals</h6>
                    </div>
                    <div class="card-body">
                        <p class="small mb-3">These borrowers have signaled "worse than expected" multiple times in the last 7 days. Consider reaching out to see if you can offer support.</p>
                        <ul class="mb-0">
                            {{for b2c_id, count in repeated_worse:}}
                            {{borrower = db.b2c(b2c_id)}}
                            <li>
                                <strong>{{=borrower.real_name}}</strong> ({{=borrower.username}}) - {{=count}} "worse" signals
                                <a href="{{=URL('compose_info_flyer', args=[b2c_id])}}" class="btn btn-sm btn-outline-success ms-2">
                                    <i class="fas fa-envelope"></i> Send info_flyer
                                </a>
                            </li>
                            {{pass}}
                        </ul>
                    </div>
                </div>
                {{pass}}
            {{else:}}
                <div class="card">
                    <div class="card-body text-center py-5">
                        <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                        <h5>No "Worse" Signals</h5>
                        <p class="text-muted">Great! No borrowers have signaled worse-than-expected outcomes in the last 7 days.</p>
                    </div>
                </div>
            {{pass}}
        </div>

        <!-- Better Signals Tab -->
        <div class="tab-pane fade" id="better" role="tabpanel">
            {{if better_signals:}}
                <div class="alert alert-success">
                    <h6><i class="fas fa-smile"></i> Positive Signals</h6>
                    <p class="mb-0 small">
                        These borrowers have signaled that things are going better than they expected. 
                        This is great information‚Äîit shows their plans are working well or conditions are favorable.
                    </p>
                </div>

                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">Signals: Better Than Expected</h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Borrower</th>
                                        <th>Activity</th>
                                        <th>Note</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {{for signal in better_signals:}}
                                    <tr>
                                        <td>{{=signal.daily_signal.signal_date.strftime('%Y-%m-%d')}}</td>
                                        <td>
                                            <strong>{{=signal.b2c.real_name}}</strong>
                                            <br><small class="text-muted">{{=signal.b2c.username}}</small>
                                        </td>
                                        <td>{{=signal.work_activity.activity_name if signal.work_activity else 'Unknown'}}</td>
                                        <td>
                                            {{if signal.daily_signal.note:}}
                                                <small>{{=signal.daily_signal.note}}</small>
                                            {{else:}}
                                                <span class="text-muted">No note provided</span>
                                            {{pass}}
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                <a href="{{=URL('b2c', args=[signal.b2c.id])}}" 
                                                   class="btn btn-outline-primary btn-sm"
                                                   title="View Borrower">
                                                    <i class="fas fa-user"></i>
                                                </a>
                                            </div>
                                        </td>
                                    </tr>
                                    {{pass}}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            {{else:}}
                <div class="card">
                    <div class="card-body text-center py-5">
                        <i class="fas fa-meh fa-3x text-muted mb-3"></i>
                        <h5>No "Better" Signals</h5>
                        <p class="text-muted">No borrowers have signaled better-than-expected outcomes in the last 7 days.</p>
                    </div>
                </div>
            {{pass}}
        </div>
    </div>

    <!-- Usage Guide -->
    <div class="card mt-4 bg-light">
        <div class="card-body">
            <h6><i class="fas fa-book"></i> How to Use Signal Information</h6>
            <div class="row small">
                <div class="col-md-6">
                    <strong>‚úÖ Good Uses of Signal Data:</strong>
                    <ul class="mb-2">
                        <li>Identify potential coordination needs (timing, resources)</li>
                        <li>Spot external shocks affecting multiple borrowers</li>
                        <li>Send info_flyers offering relevant information or support</li>
                        <li>Understand seasonal or market patterns</li>
                        <li>Celebrate successes with borrowers doing well</li>
                    </ul>
                </div>
                <div class="col-md-6">
                    <strong>‚ùå Inappropriate Uses of Signal Data:</strong>
                    <ul class="mb-2">
                        <li>Judging borrower effort or work ethic</li>
                        <li>Making unilateral decisions about credit access</li>
                        <li>Comparing borrowers to each other</li>
                        <li>Acting without borrower consent or knowledge</li>
                        <li>Using signals as performance metrics</li>
                    </ul>
                </div>
            </div>
            <p class="mb-0 mt-2"><small class="text-muted"><strong>Remember:</strong> Signals are borrower-defined and borrower-reported. They reflect the borrower's own assessment against their own plans, not any external standard.</small></p>
        </div>
    </div>
</div>

<style>
    .card {
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .table th {
        background-color: #f8f9fa;
        border-bottom: 2px solid #dee2e6;
        font-weight: 600;
        font-size: 0.9rem;
    }

    .table td {
        vertical-align: middle;
    }

    .nav-tabs .nav-link {
        color: #495057;
        font-weight: 500;
    }

    .nav-tabs .nav-link.active {
        font-weight: 600;
    }

    .badge {
        font-size: 0.85rem;
        padding: 0.4rem 0.6rem;
    }

    @media (max-width: 768px) {
        .text-right {
            text-align: left !important;
            margin-top: 1rem;
        }

        .table {
            font-size: 0.85rem;
        }

        .btn-group-sm .btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
        }
    }
</style>

<script>
// Initialize Bootstrap tabs
document.addEventListener('DOMContentLoaded', function() {
    var triggerTabList = [].slice.call(document.querySelectorAll('#signalTabs button'));
    triggerTabList.forEach(function (triggerEl) {
        var tabTrigger = new bootstrap.Tab(triggerEl);
        
        triggerEl.addEventListener('click', function (event) {
            event.preventDefault();
            tabTrigger.show();
        });
    });
});
</script>